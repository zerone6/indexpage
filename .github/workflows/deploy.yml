name: Deploy Infrastructure to Oracle Cloud

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Main Page Image
        run: |
          docker build -t main-page:latest ./main-page

      - name: Save Main Page Image
        run: |
          docker save main-page:latest | gzip > main-page-image.tar.gz

      - name: Copy Docker Image to Server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "main-page-image.tar.gz"
          target: "/tmp/"

      - name: Copy Infrastructure Files to Server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "docker-compose.yml,.gitignore,*.md,*.sh,nginx/,main-page/"
          target: "~/indexpage/"
          strip_components: 0
          rm: true

      - name: Deploy Infrastructure
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # Load main-page image
            cd /tmp
            docker load < main-page-image.tar.gz
            rm -f main-page-image.tar.gz

            # Navigate to indexpage directory
            cd ~/indexpage

            # Create networks if they don't exist
            docker network create web 2>/dev/null || true

            # Stop old containers
            docker compose down

            # Pull latest images from GHCR for other services (ignore errors if not available)
            docker compose pull highschool realestate-frontend realestate-backend 2>/dev/null || echo "GHCR images not available yet, skipping..."

            # Start nginx-proxy and main-page (essential services)
            docker compose up -d nginx-proxy main-page

            # Try to start optional services (if images are available)
            docker compose --profile full up -d 2>/dev/null || echo "Optional services not available yet"

            # Show status
            echo ""
            echo "Deployment completed successfully"
            echo "Running containers:"
            docker ps

            # Show logs for verification
            echo ""
            echo "Recent logs:"
            docker compose logs --tail=50
