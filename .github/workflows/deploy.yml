name: Deploy Infrastructure to Oracle Cloud

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Main Page Image
        run: |
          docker build -t main-page:latest ./main-page

      - name: Save Main Page Image
        run: |
          docker save main-page:latest | gzip > main-page-image.tar.gz

      - name: Backup SSL Certificates and .env on Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # Backup SSL certificates BEFORE file copy
            if [ -d ~/indexpage/nginx/ssl ] && [ -f ~/indexpage/nginx/ssl/fullchain.pem ]; then
              echo "Backing up SSL certificates..."
              mkdir -p /tmp/ssl_backup
              cp ~/indexpage/nginx/ssl/*.pem /tmp/ssl_backup/ 2>/dev/null || true
              echo "SSL certificates backed up to /tmp/ssl_backup"
              ls -la /tmp/ssl_backup/
            else
              echo "No existing SSL certificates to backup"
            fi

            # Backup .env file BEFORE file copy
            if [ -f ~/indexpage/.env ]; then
              echo "Backing up .env file..."
              cp ~/indexpage/.env /tmp/.env.backup
              echo ".env file backed up to /tmp/.env.backup"
            else
              echo "No existing .env file to backup"
            fi

      - name: Copy Docker Image to Server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "main-page-image.tar.gz"
          target: "/tmp/"

      - name: Copy Infrastructure Files to Server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "docker-compose.yml,.gitignore,*.md,*.sh,nginx/,main-page/"
          target: "~/indexpage/"
          strip_components: 0
          rm: true

      - name: Deploy Infrastructure
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # Load main-page image
            cd /tmp
            docker load < main-page-image.tar.gz
            rm -f main-page-image.tar.gz

            # Navigate to indexpage directory
            cd ~/indexpage

            # Restore SSL certificates from backup
            if [ -d /tmp/ssl_backup ] && [ -f /tmp/ssl_backup/fullchain.pem ]; then
              echo "Restoring SSL certificates..."
              mkdir -p nginx/ssl
              cp /tmp/ssl_backup/*.pem nginx/ssl/
              echo "SSL certificates restored:"
              ls -la nginx/ssl/
              rm -rf /tmp/ssl_backup
            else
              echo "WARNING: No SSL certificate backup found!"
              echo "You may need to run: sudo cp /etc/letsencrypt/live/hstarsp.net/*.pem ~/indexpage/nginx/ssl/"
            fi

            # Restore .env file from backup
            if [ -f /tmp/.env.backup ]; then
              echo "Restoring .env file..."
              cp /tmp/.env.backup .env
              echo ".env file restored"
              rm -f /tmp/.env.backup
            else
              echo "WARNING: No .env file backup found!"
              echo "You may need to create .env file manually"
            fi

            # Create networks if they don't exist
            docker network create web 2>/dev/null || true

            # Stop old containers
            docker compose down

            # Pull latest images from GHCR for other services (ignore errors if not available)
            docker compose pull highschool realestate-frontend realestate-backend 2>/dev/null || echo "Some GHCR images not available, will skip those services"

            # Start all services (nginx-proxy depends on all services, so it will start them all)
            docker compose up -d

            # Show status
            echo ""
            echo "Deployment completed successfully"
            echo "Running containers:"
            docker ps

            # Show logs for verification
            echo ""
            echo "Recent logs:"
            docker compose logs --tail=50
